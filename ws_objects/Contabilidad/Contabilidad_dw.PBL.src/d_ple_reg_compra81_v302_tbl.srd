$PBExportHeader$d_ple_reg_compra81_v302_tbl.srd
release 12.5;
datawindow(units=0 timer_interval=0 color=1073741824 brushmode=0 transparency=0 gradient.angle=0 gradient.color=8421504 gradient.focus=0 gradient.repetition.count=0 gradient.repetition.length=100 gradient.repetition.mode=0 gradient.scale=100 gradient.spread=100 gradient.transparency=0 picture.blur=0 picture.clip.bottom=0 picture.clip.left=0 picture.clip.right=0 picture.clip.top=0 picture.mode=0 picture.scale.x=100 picture.scale.y=100 picture.transparency=0 processing=0 HTMLDW=no print.printername="" print.documentname="" print.orientation = 0 print.margin.left = 110 print.margin.right = 110 print.margin.top = 96 print.margin.bottom = 96 print.paper.source = 0 print.paper.size = 0 print.canusedefaultprinter=yes print.prompt=no print.buttons=no print.preview.buttons=no print.cliptext=no print.overrideprintjob=no print.collate=yes print.background=no print.preview.background=no print.preview.outline=yes hidegrayline=no showbackcoloronxp=no picture.file="" )
header(height=0 color="536870912" transparency="0" gradient.color="8421504" gradient.transparency="0" gradient.angle="0" brushmode="0" gradient.repetition.mode="0" gradient.repetition.count="0" gradient.repetition.length="100" gradient.focus="0" gradient.scale="100" gradient.spread="100" )
summary(height=0 color="536870912" transparency="0" gradient.color="8421504" gradient.transparency="0" gradient.angle="0" brushmode="0" gradient.repetition.mode="0" gradient.repetition.count="0" gradient.repetition.length="100" gradient.focus="0" gradient.scale="100" gradient.spread="100" )
footer(height=0 color="536870912" transparency="0" gradient.color="8421504" gradient.transparency="0" gradient.angle="0" brushmode="0" gradient.repetition.mode="0" gradient.repetition.count="0" gradient.repetition.length="100" gradient.focus="0" gradient.scale="100" gradient.spread="100" )
detail(height=68 color="536870912" transparency="0" gradient.color="8421504" gradient.transparency="0" gradient.angle="0" brushmode="0" gradient.repetition.mode="0" gradient.repetition.count="0" gradient.repetition.length="100" gradient.focus="0" gradient.scale="100" gradient.spread="100" )
table(column=(type=char(4000) updatewhereclause=yes name=datos dbname="datos" )
 retrieve="  select trim(to_char(cp.ano, '0000')) || trim(to_char(cp.mes, '00')) ||  '00' 	||		--  01. CPERIODO
         '|' || trim(cp.origen) || trim(to_char(cp.ano, '0000')) 
				 || trim(to_char(cp.mes, '00')) || trim(to_char(cp.nro_libro, '00')) 
				 || trim(to_char(cp.nro_asiento, '000000')) 									||		-- 02. CNUMREGOPE
			'|' || to_char(cp.fecha_emision, 'dd/mm/yyyy')     							||		-- 03. CFECCOM
         '|' || 
				case 
					when dc.cod_sunat = '14' then
						case 	
							when trunc(cp.vencimiento) > pkg_utility.of_last_day(:ani_year, :ani_mes) then
								to_char(pkg_utility.of_last_day(:ani_year, :ani_mes), 'dd/mm/yyyy')
							else
								to_char(cp.vencimiento, 'dd/mm/yyyy')
						end 
					else
						''     													
				end																						||		-- 04. CFECVENPAG
         '|' || dc.cod_sunat                              								||		-- 05. CTIPDOCCOM
			'|' || 
				case 
					when dc.cod_sunat in (46, 50, 51, 52, 53, 54) then
						case
							when cp.serie_cp is not null then
								substr(cp.serie_cp, 2)
							else
								substr(cp.nro_doc, 2, instr(cp.nro_doc, '-') - 1)
						end
					when cp.serie_cp is null or cp.tipo_doc = 'LC' then
						case
							when instr(cp.nro_doc, '-') > 0 then
								case
									when substr(cp.nro_doc, 1, 1) in ('F', 'B') then
										substr(cp.nro_doc, 1, 1) || lpad(substr(cp.nro_doc, 2, instr(cp.nro_doc, '-') - 1), 3, '0')
									else
										lpad(substr(cp.nro_doc, 1, instr(cp.nro_doc, '-') - 1), 4, '0')
								end
							else '0000'
						end
					else
						CP.SERIE_CP											
				end																						||		-- 06. CNUMSER
			'|' ||  
				case 
					when dc.cod_sunat in (50, 52) then
				  		to_char(cp.fecha_emision, 'yyyy')
					else
				  		'0'
				end 																						||		-- 07. CEMIDUADSI
			'|' || 
          	case 
					when dc.cod_sunat in (46, 50, 51, 52, 53, 54) then
						case 
							when CP.NUMERO_CP is not null and cp.serie_cp is not null then
								PKG_UTILITY.of_trim(CP.NUMERO_CP, '0')
                   	when instr(cp.nro_doc, '-') > 0 then
                     	trim(substr(cp.nro_doc, instr(cp.nro_doc, '-') + 1))
                   	else 
								trim(cp.nro_doc)
						end
            	when CP.NUMERO_CP is null or cp.tipo_doc = 'LC' then
                 case 
                   when instr(cp.nro_doc, '-') > 0 then
                     trim(substr(cp.nro_doc, instr(cp.nro_doc, '-') + 1))
                   else 
							trim(cp.nro_doc)
                 end
            	else
              		PKG_UTILITY.of_trim(CP.NUMERO_CP, '0')
          	end 																						||		-- 08. CNUMDCOFV
			'|' || '0' 																					||		-- 09. COSDCREFIS
         '|' || p.tipo_doc_ident 																||		-- 10. CTIPDIDPRO
         '|' || DECODE(p.tipo_doc_ident, '6', p.ruc, p.nro_doc_ident) 				||    -- 11. CNUMDIDPRO
         '|' || trim(substr(replace(p.nom_proveedor, '|', ''), 1, 60)) 				||    -- 12. CNOMRSOPRO
			-- 13. Base Imponible Credito Fiscal 01
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpd.importe, cpd.importe * cp.tasa_cambio) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpd.tipo_cred_fiscal = '01') ||                                        

         -- 14. IGV Credi Fiscal 01
			'|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpi.importe, cpi.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd,
                 cp_doc_det_imp  cpi,
					  impuestos_tipo	i
           where cpd.cod_relacion 	= cp.cod_relacion
             and cpd.tipo_doc     		= cp.tipo_doc
             and cpd.nro_doc      		= cp.nro_doc
             and cpi.cod_relacion  		= cpd.cod_relacion
             and cpi.tipo_doc      		= cpd.tipo_doc
             and cpi.nro_doc       		= cpd.nro_doc
             and cpi.item          		= cpd.item
			and cpi.tipo_impuesto 	= i.tipo_impuesto
		  	and i.flag_igv				= '1'
             and cpd.tipo_cred_fiscal = '01') ||
                                        
			-- 15. Base Imponible Credito Fiscal 02
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpd.importe, cpd.importe * cp.tasa_cambio) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpd.tipo_cred_fiscal = '02') ||  

			-- 16. IGV Credi Fiscal 02                                      
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpi.importe, cpi.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd,
                 cp_doc_det_imp  cpi,
					  impuestos_tipo	i
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpi.cod_relacion  = cpd.cod_relacion
             and cpi.tipo_doc      = cpd.tipo_doc
             and cpi.nro_doc       = cpd.nro_doc
             and cpi.item          = cpd.item
			and cpi.tipo_impuesto = i.tipo_impuesto
			and i.flag_igv				= '1'
             and cpd.tipo_cred_fiscal = '02') ||                                        

			-- 17. Base Imponible Credito Fiscal 03
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpd.importe, cpd.importe * cp.tasa_cambio) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpd.tipo_cred_fiscal = '03') ||                                        

			-- 18. IGV Credi Fiscal 03
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpi.importe, cpi.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd,
                 cp_doc_det_imp  cpi,
					  impuestos_tipo	i
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpi.cod_relacion  = cpd.cod_relacion
             and cpi.tipo_doc      = cpd.tipo_doc
             and cpi.nro_doc       = cpd.nro_doc
             and cpi.item          = cpd.item
			and cpi.tipo_impuesto = i.tipo_impuesto
			and i.flag_igv				= '1'
             and cpd.tipo_cred_fiscal = '03') ||        

			-- 19. Compras no gravadas                                
         '|' ||
         trim(to_char((select nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpd.importe, cpd.importe*cp.tasa_cambio) * DECODE(dc.flag_signo, '+', 1, -1)), 0)
                         from cntas_pagar_det cpd
                        where cpd.cod_relacion = cp.cod_relacion
                          and cpd.tipo_doc     = cp.tipo_doc
                          and cpd.nro_doc      = cp.nro_doc 
								  and cpd.tipo_cred_fiscal = '04') +
                      (select nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpi.importe, cpi.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0)
                         from cntas_pagar_det cpd,
										cp_doc_det_imp  cpi,
										impuestos_tipo	 i
                        where cpd.cod_relacion 	= cp.cod_relacion
								  and cpd.tipo_doc		= cp.tipo_doc
								  and cpd.nro_doc			= cp.nro_doc
							     and cpi.cod_relacion  = cpd.cod_relacion
                          and cpi.tipo_doc      = cpd.tipo_doc
                          and cpi.nro_doc       = cpd.nro_doc 
								  and cpi.item       	= cpd.item
								  and cpi.tipo_impuesto = i.tipo_impuesto
								  and cpd.tipo_cred_fiscal = '04'
								  and i.flag_igv = '1'), '9999990.00')) ||   
			
			-- 20. Impuesto Selectivo al consumo
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpi.importe, cpi.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd,
                 cp_doc_det_imp  cpi,
					  impuestos_tipo	i
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpi.cod_relacion  = cpd.cod_relacion
             and cpi.tipo_doc      = cpd.tipo_doc
             and cpi.nro_doc       = cpd.nro_doc
             and cpi.item          = cpd.item
             and cpi.tipo_impuesto = i.tipo_impuesto
				 and cpi.tipo_impuesto = 'ISC') ||  
			
         -- 21. Otros cargos o Impuestos                             	
         '|' ||
         (select trim(to_char(nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpi.importe, cpi.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0), '9999990.00'))
            from cntas_pagar_det cpd,
                 cp_doc_det_imp  cpi,
					  impuestos_tipo	i
           where cpd.cod_relacion = cp.cod_relacion
             and cpd.tipo_doc     = cp.tipo_doc
             and cpd.nro_doc      = cp.nro_doc
             and cpi.cod_relacion  = cpd.cod_relacion
             and cpi.tipo_doc      = cpd.tipo_doc
             and cpi.nro_doc       = cpd.nro_doc
             and cpi.item          = cpd.item
 				 and cpi.tipo_impuesto = i.tipo_impuesto
				 and cpi.tipo_impuesto <> 'ISC'
				 and i.flag_igv		  = '0') ||                                        	

			-- 22. Importe Total del documento               
         '|' ||
         trim(to_char((select nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , cpd.importe, cpd.importe*cp.tasa_cambio) * DECODE(dc.flag_signo, '+', 1, -1)), 0)
                         from cntas_pagar_det cpd
                        where cpd.cod_relacion = cp.cod_relacion
                          and cpd.tipo_doc     = cp.tipo_doc
                          and cpd.nro_doc      = cp.nro_doc ) +
                      (select nvl(sum(DECODE(cp.cod_moneda , PKG_LOGISTICA.of_soles(null) , ci.importe, ci.importe*cp.tasa_cambio) * DECODE(i.signo, '-', -1, 1) * DECODE(dc.flag_signo, '+', 1, -1)), 0)
                         from cp_doc_det_imp  ci,
										impuestos_tipo	 i
                        where ci.cod_relacion  = cp.cod_relacion
                          and ci.tipo_doc      = cp.tipo_doc
                          and ci.nro_doc       = cp.nro_doc 
								  and ci.tipo_impuesto = i.tipo_impuesto), '9999990.00')) ||   
     
         '|' || trim(to_char(cp.tasa_cambio, '9990.000')) ||                            -- 23. Tasa Cambio
         '|' ||
         case 
           when cp.tipo_doc in ('NCP', 'NDP', 'CNC', 'CDB') then
            (select to_char(cp2.fecha_emision, 'dd/mm/yyyy')
               from doc_referencias dr,
                    cntas_pagar     cp2
              where dr.proveedor_ref = cp2.cod_relacion
                and dr.tipo_ref      = cp2.tipo_doc
                and dr.nro_ref       = cp2.nro_doc
                and dr.cod_relacion  = cp.cod_relacion
                and dr.tipo_doc      = cp.tipo_doc
                and dr.nro_doc       = cp.nro_doc
                and rownum           = 1)
           else
             '01/01/0001'
         end ||                                                                         -- 24. Fecha de emision del documento de referencia
         '|' ||
         case 
           when cp.tipo_doc in ('NCP', 'NDP', 'CNC', 'CDB') then
            (select dt2.cod_sunat
               from doc_referencias dr,
                    cntas_pagar     cp2,
                    doc_tipo        dt2
              where dr.proveedor_ref = cp2.cod_relacion
                and dr.tipo_ref      = cp2.tipo_doc
                and dr.nro_ref       = cp2.nro_doc
                and cp2.tipo_doc     = dt2.tipo_doc
                and dr.cod_relacion  = cp.cod_relacion
                and dr.tipo_doc      = cp.tipo_doc
                and dr.nro_doc       = cp.nro_doc
					 and rownum				 = 1)
           else
             '00'
         end ||                                                                         -- 25. Tipo Documento Referencia
         '|' ||
         case 
           when cp.tipo_doc in ('NCP', 'NDP', 'CNC', 'CDB') then
            (select case
                      when instr(cp2.nro_doc, '-' ) > 0 then
                        lpad(substr(cp2.nro_doc, 1, instr(cp2.nro_doc, '-' ) - 1), 4, '0')
                      else
                        '0000'
                    end
               from doc_referencias dr,
                    cntas_pagar     cp2,
                    doc_tipo        dt2
              where dr.proveedor_ref = cp2.cod_relacion
                and dr.tipo_ref      = cp2.tipo_doc
                and dr.nro_ref       = cp2.nro_doc
                and cp2.tipo_doc     = dt2.tipo_doc
                and dr.cod_relacion  = cp.cod_relacion
                and dr.tipo_doc      = cp.tipo_doc
                and dr.nro_doc       = cp.nro_doc
					 and rownum				 = 1 )
           else
             '-'
         end ||                                                                         -- 26. Serie Documento Referencia
         '|' ||
         case 
           when cp.tipo_doc in ('NCP', 'NDP', 'CNC', 'CDB') then
            (select case
                      when instr(cp2.nro_doc, '-' ) > 0 then
                        trim(substr(cp2.nro_doc, instr(cp2.nro_doc, '-' ) + 1))
                      else
                        '0000'
                    end
               from doc_referencias dr,
                    cntas_pagar     cp2,
                    doc_tipo        dt2
              where dr.proveedor_ref = cp2.cod_relacion
                and dr.tipo_ref      = cp2.tipo_doc
                and dr.nro_ref       = cp2.nro_doc
                and cp2.tipo_doc     = dt2.tipo_doc
                and dr.cod_relacion  = cp.cod_relacion
                and dr.tipo_doc      = cp.tipo_doc
                and dr.nro_doc       = cp.nro_doc
				    and rownum				 = 1)
           else
             '-'
         end ||                                                                         -- 27. Numero Documento Referencia
			'|' || '-' 													||                             -- 28. Número del comprobante de pago emitido por sujeto no domiciliado (5).
         '|' || 
			case
				when d.fecha_deposito is null then
					'01/01/0001'
				else
					to_char(d.fecha_deposito, 'dd/mm/yyyy')	
			end 															||                             -- 29. Fecha emision constancia deposito detraccion
         '|' || 
			case
				when d.nro_deposito is null then
					'0'
				else
					d.nro_deposito                          	
			end 															||                             -- 30. Nro de constancia deposito Detraccion
         '|' || 
			case
				when (select count(*)
							from caja_bancos cb,
								  caja_bancos_det cbd
							where cb.origen = cbd.origen
							  and cb.nro_registro = cbd.nro_registro
							  and cbd.cod_relacion = cp.cod_relacion
							  and cbd.tipo_doc	  = cp.tipo_doc
							  and cbd.nro_doc		  = cp.nro_doc
							  and cbd.flag_ret_igv = '1'   
						) > 0 then '1'	
				else '0'
			end 															||                             -- 31. Marca de comprobante sujeto a retencion
         '|' || 
			case 
				when dc.cod_sunat in ('01') then '1'
				else
					'6'
			end                                     			||                             	-- 32. Estado que identifica la oportunidad de la anotación o indicación si ésta corresponde a un ajuste.
			'|' || trim(cp.origen) || trim(to_char(cp.ano, '0000')) 
				 || trim(to_char(cp.mes, '00')) || trim(to_char(cp.nro_libro, '00')) 
				 || trim(to_char(cp.nro_asiento, '000000')) 									||			-- 33. CINTDIAMAY
			'|' || trim(cp.origen) || trim(to_char(cp.ano, '0000')) 
				 || trim(to_char(cp.mes, '00')) || trim(to_char(cp.nro_libro, '00')) 
				 || trim(to_char(cp.nro_asiento, '000000')) 									||			-- 34. CINTKARDEX
			'|' || trim(cp.origen) || trim(to_char(cp.ano, '0000')) 
				 || trim(to_char(cp.mes, '00')) || trim(to_char(cp.nro_libro, '00')) 
				 || trim(to_char(cp.nro_asiento, '000000')) 									||			-- 35. CINTREG
         '|' as datos
  from   cntas_pagar cp,
         proveedor   p,
         doc_tipo    dc,
         detraccion  d
  where  cp.cod_relacion            	= p.proveedor
    AND  cp.tipo_doc                	= dc.tipo_doc
    and  cp.nro_detraccion          	= d.nro_detraccion   (+)
    AND  cp.flag_estado             	<> '0'
    AND  cp.ano            				= :ani_year
    AND  cp.mes								= :ani_mes
    AND  cp.nro_libro               	= '03'
    and  cp.tipo_doc                	not in ('RE')
    and  NVL(p.flag_personeria, 'N')	<> 'E'
   ORDER BY p.nom_proveedor, cp.tipo_doc, cp.nro_doc
" arguments=(("ani_year", number),("ani_mes", number)) )
column(band=detail id=1 alignment="0" tabsequence=32766 border="0" color="33554432" x="5" y="4" height="56" width="8165" format="[general]" html.valueishtml="0"  name=datos visible="1" edit.limit=400 edit.case=any edit.autoselect=yes edit.autohscroll=yes  font.face="Courier New" font.height="-7" font.weight="400"  font.family="3" font.pitch="1" font.charset="0" background.mode="1" background.color="536870912" background.transparency="0" background.gradient.color="8421504" background.gradient.transparency="0" background.gradient.angle="0" background.brushmode="0" background.gradient.repetition.mode="0" background.gradient.repetition.count="0" background.gradient.repetition.length="100" background.gradient.focus="0" background.gradient.scale="100" background.gradient.spread="100" tooltip.backcolor="134217752" tooltip.delay.initial="0" tooltip.delay.visible="32000" tooltip.enabled="0" tooltip.hasclosebutton="0" tooltip.icon="0" tooltip.isbubble="0" tooltip.maxwidth="0" tooltip.textcolor="134217751" tooltip.transparency="0" transparency="0" )
htmltable(border="1" )
htmlgen(clientevents="1" clientvalidation="1" clientcomputedfields="1" clientformatting="0" clientscriptable="0" generatejavascript="1" encodeselflinkargs="1" netscapelayers="0" pagingmethod=0 generatedddwframes="1" )
xhtmlgen() cssgen(sessionspecific="0" )
xmlgen(inline="0" )
xsltgen()
jsgen()
export.xml(headgroups="1" includewhitespace="0" metadatatype=0 savemetadata=0 )
import.xml()
export.pdf(method=0 distill.custompostscript="0" xslfop.print="0" )
export.xhtml()
 