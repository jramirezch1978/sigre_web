<app-main-layout>
  <!-- Page Header -->
  <div class="page-title">
    <div class="title_left">
      <h3>
        <mat-icon style="vertical-align: middle; margin-right: 10px;">assessment</mat-icon>
        Reporte de Asistencia
      </h3>
      <p class="subtitle">Análisis detallado de horas trabajadas, tardanzas y asistencia del personal</p>
    </div>
  </div>

  <div class="clearfix"></div>

  <!-- Reporte Content -->
  <div class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>
            <mat-icon class="panel-icon">filter_list</mat-icon>
            Filtros de Búsqueda
          </h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          
              <!-- Filtros Principales -->
              <div class="filter-row">
                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Origen</mat-label>
                  <mat-select [(ngModel)]="codOrigen" (selectionChange)="onFiltroChange()">
                    <mat-option *ngFor="let origen of origenes" [value]="origen.codOrigen">
                      {{ origen.codOrigen }} - {{ origen.nombre }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Fecha Inicio</mat-label>
                  <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" (dateChange)="onFiltroChange()">
                  <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
                  <mat-datepicker #pickerInicio></mat-datepicker>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Fecha Fin</mat-label>
                  <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" (dateChange)="onFiltroChange()">
                  <mat-datepicker-toggle matIconSuffix [for]="pickerFin"></mat-datepicker-toggle>
                  <mat-datepicker #pickerFin></mat-datepicker>
                </mat-form-field>

                <button mat-raised-button color="primary" (click)="cargarReporte()" [disabled]="cargando">
                  <mat-icon>refresh</mat-icon>
                  Actualizar
                </button>

                <button mat-raised-button color="accent" (click)="exportarExcel()" [disabled]="cargando || registros.length === 0">
                  <mat-icon>file_download</mat-icon>
                  Excel
                </button>

                <button mat-raised-button (click)="exportarPDF()" [disabled]="cargando || registros.length === 0">
                  <mat-icon>picture_as_pdf</mat-icon>
                  PDF
                </button>
              </div>

              <!-- Filtros de Búsqueda -->
              <div class="filter-row" style="margin-top: 15px;">
                <mat-form-field appearance="outline" class="filter-field-search">
                  <mat-label>Buscar por Nombre, Código o DNI</mat-label>
                  <input matInput [(ngModel)]="busquedaNombre" (ngModelChange)="onFiltroBusqueda()" placeholder="Búsqueda contextual...">
                  <mat-icon matPrefix>search</mat-icon>
                </mat-form-field>

                <mat-form-field appearance="outline" class="filter-field">
                  <mat-label>Tipo de Trabajador</mat-label>
                  <mat-select [(ngModel)]="tipoTrabajadorFiltro" (selectionChange)="onFiltroBusqueda()">
                    <mat-option *ngFor="let tipo of tiposTrabajador" [value]="tipo">
                      {{ tipo }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <div class="results-info">
                  <mat-icon>info</mat-icon>
                  <span>Mostrando {{ registrosFiltrados.length }} de {{ registros.length }} registros</span>
                </div>
              </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Generando reporte...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !cargando" class="error-container">
    <mat-icon>error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="cargarReporte()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>

  <!-- Tabla de resultados -->
  <div *ngIf="!cargando && !error" class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>
            <mat-icon class="panel-icon">table_chart</mat-icon>
            Resultados: {{ registros.length }} registros
          </h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          
          <div class="table-responsive">
            <table class="table table-striped jambo_table bulk_action">
              <thead>
                <tr class="headings">
                  <th class="column-title sortable" (click)="ordenarPor('nro')">
                    N°
                    <mat-icon class="sort-icon" *ngIf="columnaOrdenada === 'nro'">
                      {{ ordenAscendente ? 'arrow_upward' : 'arrow_downward' }}
                    </mat-icon>
                  </th>
                  <th class="column-title sortable" (click)="ordenarPor('tipoTrabajador')">
                    Tipo de<br>Trabajador
                    <mat-icon class="sort-icon" *ngIf="columnaOrdenada === 'tipoTrabajador'">
                      {{ ordenAscendente ? 'arrow_upward' : 'arrow_downward' }}
                    </mat-icon>
                  </th>
                  <th class="column-title sortable" (click)="ordenarPor('codigoTrabajador')">Código<br>Trabajador</th>
                  <th class="column-title sortable" (click)="ordenarPor('dni')">DNI</th>
                  <th class="column-title sortable" (click)="ordenarPor('apellidosNombres')">
                    Apellidos y<br>Nombres
                    <mat-icon class="sort-icon" *ngIf="columnaOrdenada === 'apellidosNombres'">
                      {{ ordenAscendente ? 'arrow_upward' : 'arrow_downward' }}
                    </mat-icon>
                  </th>
                  <th class="column-title sortable" (click)="ordenarPor('area')">Área</th>
                  <th class="column-title sortable" (click)="ordenarPor('cargoPuesto')">Cargo /<br>Puesto</th>
                  <th class="column-title sortable" (click)="ordenarPor('turno')">Turno</th>
                  <th class="column-title sortable" (click)="ordenarPor('fecha')">
                    Fecha
                    <mat-icon class="sort-icon" *ngIf="columnaOrdenada === 'fecha'">
                      {{ ordenAscendente ? 'arrow_upward' : 'arrow_downward' }}
                    </mat-icon>
                  </th>
                  <th class="column-title sortable" (click)="ordenarPor('horaIngreso')">Hora de<br>Ingreso</th>
                  <th class="column-title sortable" (click)="ordenarPor('horaSalida')">Hora de<br>Salida</th>
                  <th class="column-title sortable" (click)="ordenarPor('horasTrabajadas')">
                    Horas<br>Trabajadas
                    <mat-icon class="sort-icon" *ngIf="columnaOrdenada === 'horasTrabajadas'">
                      {{ ordenAscendente ? 'arrow_upward' : 'arrow_downward' }}
                    </mat-icon>
                  </th>
                  <th class="column-title sortable" (click)="ordenarPor('horasExtras')">Horas<br>Extras</th>
                  <th class="column-title sortable" (click)="ordenarPor('tardanzaMin')">
                    Tardanza<br>(min)
                    <mat-icon class="sort-icon" *ngIf="columnaOrdenada === 'tardanzaMin'">
                      {{ ordenAscendente ? 'arrow_upward' : 'arrow_downward' }}
                    </mat-icon>
                  </th>
                  <th class="column-title sortable" (click)="ordenarPor('totalHorasTrabajadasSemana')">Total Horas<br>Trabajadas<br>(Semana)</th>
                  <th class="column-title sortable" (click)="ordenarPor('totalHorasExtrasSemana')">Total Horas<br>Extras<br>(Semana)</th>
                  <th class="column-title sortable" (click)="ordenarPor('totalDiasAsistidos')">Total Días<br>Asistidos</th>
                  <th class="column-title sortable" (click)="ordenarPor('totalFaltas')">Total<br>Faltas</th>
                  <th class="column-title sortable" (click)="ordenarPor('porcAsistencia')">%<br>Asistencia</th>
                  <th class="column-title sortable" (click)="ordenarPor('porcAusentismo')">%<br>Ausentismo</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of registrosFiltrados" class="even pointer" [class.tardanza-alta]="row.tardanzaMin > 15">
                  <td>{{ row.nro }}</td>
                  <td>{{ row.tipoTrabajador }}</td>
                  <td>{{ row.codigoTrabajador }}</td>
                  <td>{{ row.dni }}</td>
                  <td>{{ row.apellidosNombres }}</td>
                  <td>{{ row.area }}</td>
                  <td>{{ row.cargoPuesto }}</td>
                  <td>{{ row.turno }}</td>
                  <td>{{ row.fecha | date: 'dd/MM/yyyy' }}</td>
                  <td>{{ row.horaIngreso | date: 'HH:mm:ss' }}</td>
                  <td>
                    <span *ngIf="row.horaSalida">{{ row.horaSalida | date: 'HH:mm:ss' }}</span>
                    <span *ngIf="!row.horaSalida" class="label label-warning">Pendiente</span>
                  </td>
                  <td>{{ row.horasTrabajadas | number: '1.2-2' }}</td>
                  <td>{{ row.horasExtras | number: '1.2-2' }}</td>
                  <td [class.tardanza-warning]="row.tardanzaMin > 15">{{ row.tardanzaMin }}</td>
                  <td>{{ row.totalHorasTrabajadasSemana | number: '1.2-2' }}</td>
                  <td>{{ row.totalHorasExtrasSemana | number: '1.2-2' }}</td>
                  <td>{{ row.totalDiasAsistidos }}</td>
                  <td>{{ row.totalFaltas }}</td>
                  <td>{{ row.porcAsistencia | number: '1.2-2' }}%</td>
                  <td>{{ row.porcAusentismo | number: '1.2-2' }}%</td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

</app-main-layout>
