<app-main-layout>
  <!-- Page Header -->
  <div class="page-title">
    <div class="title_left">
      <h3>
        <mat-icon style="vertical-align: middle; margin-right: 10px;">assessment</mat-icon>
        Reporte de Asistencia
      </h3>
      <p class="subtitle">Análisis detallado de horas trabajadas, tardanzas y asistencia del personal</p>
    </div>
  </div>

  <div class="clearfix"></div>

  <!-- Reporte Content -->
  <div class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>
            <mat-icon class="panel-icon">filter_list</mat-icon>
            Filtros de Búsqueda
          </h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          
          <!-- Filtros -->
          <div class="filter-row">
            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Origen</mat-label>
              <mat-select [(ngModel)]="codOrigen" (selectionChange)="onFiltroChange()">
                <mat-option *ngFor="let origen of origenes" [value]="origen.codOrigen">
                  {{ origen.codOrigen }} - {{ origen.nombre }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Fecha Inicio</mat-label>
              <input matInput [matDatepicker]="pickerInicio" [(ngModel)]="fechaInicio" (dateChange)="onFiltroChange()">
              <mat-datepicker-toggle matIconSuffix [for]="pickerInicio"></mat-datepicker-toggle>
              <mat-datepicker #pickerInicio></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="filter-field">
              <mat-label>Fecha Fin</mat-label>
              <input matInput [matDatepicker]="pickerFin" [(ngModel)]="fechaFin" (dateChange)="onFiltroChange()">
              <mat-datepicker-toggle matIconSuffix [for]="pickerFin"></mat-datepicker-toggle>
              <mat-datepicker #pickerFin></mat-datepicker>
            </mat-form-field>

            <button mat-raised-button color="primary" (click)="cargarReporte()" [disabled]="cargando">
              <mat-icon>refresh</mat-icon>
              Actualizar
            </button>

            <button mat-raised-button color="accent" (click)="exportarExcel()" [disabled]="cargando || registros.length === 0">
              <mat-icon>file_download</mat-icon>
              Excel
            </button>

            <button mat-raised-button (click)="exportarPDF()" [disabled]="cargando || registros.length === 0">
              <mat-icon>picture_as_pdf</mat-icon>
              PDF
            </button>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="cargando" class="loading-container">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Generando reporte...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !cargando" class="error-container">
    <mat-icon>error_outline</mat-icon>
    <p>{{ error }}</p>
    <button mat-raised-button color="primary" (click)="cargarReporte()">
      <mat-icon>refresh</mat-icon>
      Reintentar
    </button>
  </div>

  <!-- Tabla de resultados -->
  <div *ngIf="!cargando && !error" class="row">
    <div class="col-md-12">
      <div class="x_panel">
        <div class="x_title">
          <h2>
            <mat-icon class="panel-icon">table_chart</mat-icon>
            Resultados: {{ registros.length }} registros
          </h2>
          <div class="clearfix"></div>
        </div>
        <div class="x_content">
          
          <div class="table-responsive">
            <table class="table table-striped jambo_table bulk_action">
              <thead>
                <tr class="headings">
                  <th class="column-title">Nro</th>
                  <th class="column-title">Tipo</th>
                  <th class="column-title">Código</th>
                  <th class="column-title">DNI</th>
                  <th class="column-title">Apellidos y Nombres</th>
                  <th class="column-title">Área</th>
                  <th class="column-title">Cargo</th>
                  <th class="column-title">Turno</th>
                  <th class="column-title">Fecha de Marcación</th>
                  <th class="column-title">Ingreso</th>
                  <th class="column-title">Salida</th>
                  <th class="column-title">Hrs. Trab.</th>
                  <th class="column-title">Hrs. Extras</th>
                  <th class="column-title">Tard.</th>
                  <th class="column-title">Tot. Hrs Sem</th>
                  <th class="column-title">Extras Sem</th>
                  <th class="column-title">Días</th>
                  <th class="column-title">Faltas</th>
                  <th class="column-title">% Asis.</th>
                  <th class="column-title">% Ausent.</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let row of registrosFiltrados" class="even pointer">
                  <td>{{ row.nro }}</td>
                  <td>{{ row.tipoTrabajador }}</td>
                  <td>{{ row.codigoTrabajador }}</td>
                  <td>{{ row.dni }}</td>
                  <td>{{ row.apellidosNombres }}</td>
                  <td>{{ row.area }}</td>
                  <td>{{ row.cargoPuesto }}</td>
                  <td>{{ row.turno }}</td>
                  <td>{{ row.fecha | date: 'dd/MM/yyyy' }}</td>
                  <td>{{ row.horaIngreso | date: 'HH:mm:ss' }}</td>
                  <td>
                    <span *ngIf="row.horaSalida">{{ row.horaSalida | date: 'HH:mm:ss' }}</span>
                    <span *ngIf="!row.horaSalida" class="label label-warning">Pendiente</span>
                  </td>
                  <td>{{ row.horasTrabajadas }}</td>
                  <td>{{ row.horasExtras | number: '1.2-2' }}</td>
                  <td>{{ row.tardanzaMin }}</td>
                  <td>{{ row.totalHorasTrabajadasSemana | number: '1.2-2' }}</td>
                  <td>{{ row.totalHorasExtrasSemana | number: '1.2-2' }}</td>
                  <td>{{ row.totalDiasAsistidos }}</td>
                  <td>{{ row.totalFaltas }}</td>
                  <td>{{ row.porcAsistencia | number: '1.2-2' }}%</td>
                  <td>{{ row.porcAusentismo | number: '1.2-2' }}%</td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>

</app-main-layout>
